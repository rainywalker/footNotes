!function(){"use strict";var t,e=tinymce.util.Tools.resolve("tinymce.PluginManager");"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t.apply(this,[this[e],e,this])}),Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(Element.prototype,"textContent").get&&(t=Object.getOwnPropertyDescriptor(Element.prototype,"innerText"),Object.defineProperty(Element.prototype,"textContent",{get:function(){return t.get.call(this)},set:function(e){return t.set.call(this,e)}}));var n=function(t,e){var n=t;for(var o in e)n=n.replace(/\{(\/?[^\}]+)\}/gm,e[o]);return n},o=function(t){var e=t.selection.getNode(),o="",r="SPAN"==e.tagName&&"fnoteWrap"===t.dom.getAttrib(e,"class"),i="fnoteWrap"==e.className?e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,""):e.childNodes[0];r&&(o=e.name||decodeURIComponent(e.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert Contents",size:"normal",body:{type:"panel",items:[{type:"textarea",name:"name",multiline:!0,minWidth:520,minHeight:100}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:{name:o},onSubmit:function(e){var o,r,a,c,l=e.getData().name,s='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button type="button" class="fnoteBtn" data-content="'+encodeURIComponent(l)+'">{FOOTNOTE_INDEX}</button></span>',f=t.getDoc().querySelectorAll(".fnoteBtn"),u=f.length,p=(r=t.selection.getNode(),a=function(t){var e=!1;return(e=[].filter.call(t.parentNode.children,function(n){return n.previousElementSibling===t?e=!0:e})).map(e=>Array.from(e.querySelectorAll("fnoteBtn").length)>0?$node.nextElementSibling.classList.contains("fnoteBtn")?$node.nextElementSibling.children.children:e.querySelectorAll(".fnoteBtn"):"BODY"===t.nodeName?[]:a(t.parentNode))},c=function(t,e){if(!e)return!1;if(e)return $node;var n=null;return e.children.forEach(function(){e&&(n=c(t,this))}),n},function(t,e){for(var n=a(e);0!==n.length;){var o=c(t,n);if(null!==o)return o;n=a(n)}return n}(".fnoteBtn",r));if(p.length){var d;for(p=p[0],d=0;d<u&&p!=f[d];d++);i<u?o=n(s,{FOOTNOTE_INDEX:$(f[i-1]).html()}):(o=n(s,{FOOTNOTE_INDEX:$(f[d]).html()}),t.selection.collapse(0))}else o=n(s,{FOOTNOTE_INDEX:u+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,o),e.close(),Array.from(t.getDoc().querySelectorAll(".fnoteBtn")).forEach(function(t,e){t.textContent=e+1,t.parentNode.setAttribute("id","#wk_ft"+(e+1))})}})},r={register:function(t){t.addCommand("footnotes",function(){o(t)})}},i={register:function(t){t.ui.registry.addToggleButton("footnotes",{icon:"fnote",tooltip:"Footnote",onAction:function(){return t.execCommand("footnotes")},onSetup:function(e){return t.selection.selectorChangedWithUnbind("span.fnoteWrap",e.setActive).unbind}}),t.ui.registry.addMenuItem("footnotes",{icon:"fnote",onAction:function(){return t.execCommand("footnotes")}})}};e.add("footnotes",function(t){t.ui.registry.addIcon("fnote",'<img src="'+tinyMCE.baseURL+'/plugins/footnotes/img/fn.png">'),r.register(t),i.register(t)})}();